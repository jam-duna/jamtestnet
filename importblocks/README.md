# importblocks CLI Tool

## Overview

`importblocks` is a command-line tool designed to test JAM implementations by generating and sending a stream of blocks (both valid and invalid) to a team-specified HTTP or QUIC endpoint. The `importblocks` tool is part of a larger test suite to help teams verify their block validation logic by sending a variety of block scenarios in different modes and checking if an implementation can correctly validate blocks. Implementations should determine if the blocks are valid and subsequently advance their chain based on this validation, updating the state trie if valid and outputting key-value pairs along with a state root. A genesis state/configuration may be supplied.

The specific goal for `importblocks` is to support JAM implementation teams in reaching *M1 Import Blocks* + *M2 Author* milestones at present. We envision it can support mature JAM implementations beyond this use case as part of a larger, advanced JAM Supercomputing Test Suite.

_Important:_ As of Feb 2025, this is in a _PoC (proof-of-concept) stage only_ and is a community-generated effort, not from W3F or Parity. Any implementation of `importblocks` should be considered ***100% unofficial***, and any success metrics—while aiming to be 100% diagnostic—do not directly relate to official JAM Prize milestone achievements. A more official version can be expected from W3F (see [this issue](https://github.com/w3f/jamtestvectors/issues/21)).

`importblocks` supports the following modes:

- **fallback**: Generates extrinsic-less blocks.
- **safrole**: Generates blocks with ticket extrinsics only.
- **assurances**: Generates blocks with extrinsics for guarantees, assurances, and preimages, in addition to tickets.

Additional modes are planned, as documented below.

## Features

- **StateTransition Delivery**: StateTransition (ST) will be primarily delivered through HTTP. QUIC communication is planned but not exposed before M2.
- **Randomized Validity**: The ST generated by `importblocks` can be valid or invalid, mixed in no particular order, challenging teams to determine each block’s correctness.
- **Grading**: Metrics are automatically gathered at the end of each run.

## Installation

JAM DUNA's `importblocks` CLI is scheduled for a PoC release in Early Feb.

### Prerequisites

- **Google Cloud Account**: You’ll need permissions to pull images from Google Artifact Registry (GAR) in your project or organization.
- **Docker**: Ensure Docker is installed and running on your system.  
  - [Docker Installation Docs](https://docs.docker.com/get-docker/)
- **gcloud CLI**: Installed and authenticated with your Google Cloud account.  
  - [gcloud CLI Installation](https://cloud.google.com/sdk/docs/install)

## Configure Docker to Pull from Google Artifact Registry

Run the following command to configure Docker for authentication:

~~~bash
gcloud auth configure-docker us-central1-docker.pkg.dev
~~~

### Running `importblocks` via Docker Image

JAM Duna's `importblocks` image is periodically published to [GAR](https://us-central1-docker.pkg.dev/jam-duna/importblocks/importblocks) and can be pulled directly:

~~~bash
docker pull us-central1-docker.pkg.dev/jam-duna/importblocks/importblocks:0.6.1.0
~~~

Then executed with:

~~~bash
docker exec -it importblocks_container ./importblocks \
    --mode=safrole \
    --http='http://implementation.jamduna.org:8088' \
    --invalidrate=0.31459 \
    --numblocks=50 --statistics=25
~~~

### Running `importblocks` via BASH (Recommended)

Alternatively, use the [**importblocks_runner script**](https://github.com/jam-duna/jamtestnet/blob/main/importblocks/importblocks_runner.sh) provided in the [**jam-duna/testnet**](https://github.com/jam-duna/jamtestnet) repo:

~~~bash
# Example usage
./importblocks_runner.sh \
    http="http://implementation.jamduna.org:8088" \
    mode="fallback" \
    numblocks="100" \
    invalidrate="0.20" \
    statistics="10"
~~~

### Modes

* **Modes covered by Feb PoC:**
  - [x] `validation-only`: set `mode=<>` and `invalidrate=0` for validation mode.
  - [x] ~~`fallback`: Generates PreStates & Blocks for extrinsic-less slots.~~ (Ignored as there is nothing to fuzz.)
  - [x] `safrole`: Generates PreStates & Blocks with ticket extrinsics where \|E_T\| ≥ 0 but no other extrinsics (\|E_A\|=\|E_G\|=\|E_P\|=\|E_D\|=0).
  - [x] `assurances`: Generates PreStates & Blocks with guarantees (\|E_G\|≥ 0), assurances (\|E_A\|≥ 0), and preimages (\|E_P\|≥ 0) in addition to ticket extrinsics, but no disputes (\|E_D\|=0).
  - [ ] `generic`: Generates *blended* PreStates & Blocks — not constrained by a particular mode (aka `full_fuzz`).

* **Planned for 2025 Q1/Q2**: partially implemented but not exposed for external fuzzing.
  - [ ] `report`: covering `orderedaccumulation, authorization, recenthistory, blessed`
  - [ ] `orderedaccumulation`: same as `assurances` but also adjusting C(14), including prerequisites
  - [ ] `authorization`: same as `assurances`, but also adjusting C(1)+C(2)
  - [ ] `recenthistory`: same as `assurances`, but also adjusting C(3)
  - [ ] `blessed`: same as `assurances`, but also adjusting C(5), C(12)
  - [ ] `basichostfunctions`: same as `assurances`, but using the most common host functions
  - [ ] `finalization`: combines all of the above, adjusting everything in C(1)-C(15), except disputes
  - [ ] `disputes`: combines all of the above, including dispute extrinsics (\|E_D\|\≥0).
  - [ ] `conformance`: every single host function

## Required Flags & Options

```
docker exec -it importblocks_container ./importblocks –help

importblocks - JAM Duna Import Blocks generator
Usage: importblocks [OPTIONS]

Options:
–dir          Storage directory (default:/tmp/importBlock)
–invalidrate  Percentage of invalid blocks (default:0.14285)
–numblocks    Number of blocks to generate (default:100)
–statistics   Print statistics interval (default:20)
-h, –http     HTTP endpoint to send blocks (default:http://localhost:8088/)
-m, –mode     Block generation mode (default:safrole)
-n, –network  JAM network size (default:tiny)
-q, –quic     QUIC endpoint to send blocks (default:)
-v, –verbose  Enable detailed logging (default:false)
```

**Note**:  
1. When `invalidrate` is set to 0, `importblocks` will stop fuzzing completely.  
2. Full network settings are not exposed in this PoC.

### Required Flags

You must specify either an HTTP URL or a QUIC address as the endpoint for `importblocks` to deliver PreState & Blocks:

- [x] **`--http=<url>`**: HTTP URL where `importblocks` will POST generated PreState & Blocks and expect a timely response from the end-client.
- [ ] **`--quic=<ip:port>`**: IP and port for sending generated blocks over QUIC (***not exposed in PoC***).

#### Blocks via HTTP

~~~bash
docker exec -it importblocks_container ./importblocks \
    --http='http://localhost:8088'
~~~

#### Sending Blocks via QUIC

~~~bash
docker exec -it importblocks_container ./importblocks \
    --quic="127.0.0.1:3033"
~~~

*(QUIC is Not exposed in PoC.)*

## How `importblocks` Works

1. **Block Generation**  
   Based on the selected mode, `importblocks` loads presumably *valid* state transitions (STFs) from an external source (e.g., a `data.zip` file or test bank) and applies various fuzzing techniques. A randomly selected “error” is introduced according to the user-specified `invalidrate`. The original and mutated state transitions are then reshuffled before submission.

2. **Endpoint Submission**  
   `importblocks` sends a `PrestateAndBlock` to the specified HTTP or QUIC endpoint. As soon as a `StateTransitionResponse` is received, the next `PrestateAndBlock` is sent.

3. **Team Validation**  
   It is up to the endpoint to determine whether each block is valid or invalid. For a valid block, the endpoint should respond with a post-state or indicate a detected fuzzing error.

4. **Response Handling**  
   - **HTTP Endpoint**:  
     - **200 OK**: For a valid block, the endpoint returns JSON containing a `PostState`, which must include:
       - `keyvals`: a set of key-value pairs representing the state trie
       - `stateroot`: the resulting state root hash  
     - **406 Bad Request**: For an invalid block, the endpoint returns a `406 Bad Request` response with the relevant state transition error.
   - **QUIC Endpoint**:  
     Returns a `StateTransitionResponse` in a special codec. (Not exposed in this PoC.)

5. **Grading & Statistics**  
   Metrics are generated periodically at an interval set by the `statistics` parameter. These metrics are for informational purposes only and *do not* determine correctness of the sender or receiver implementation.

### Example of a Team’s Expected Response

If a block is valid, the team’s endpoint should return a `200 OK` status with JSON containing a `keyvals` array (representing the state trie) and a `stateroot` (the new state root hash). For an invalid block, the endpoint should return a `406 Bad Request` (or `400 Bad Request`) response.

#### Example `PrestateAndBlock` Submission from `importblocks` to a Team Implementation

```
// PrestateAndBlock = PreState++Block
{
  "pre_state": {
    "state_root": "0x1234abcd...2345",
    "keyvals": [
      [
        "0x1234abcd...2345", // 32 bytes key
        "0xabcd..",
        "optional_label",
        "optional_metadata"
      ],
      ...
    ]
  },
  "block": {
    "header": {...},
    "extrinsic": {...}
  }
}
```

#### Example HTTP Response for a Valid Transition (200 OK)

```
// PostState
{
    "state_root": "0x1234abcd...2345",
    "keyvals": [
      [
        "0x1234abcd...2345", // 32 bytes key
        "0xabcd..",
        "optional_label",
        "optional_metadata"
      ],
      ...
    ]
}
```


#### Example HTTP Response for an Invalid Transition (406 Bad Request)

*Note:This should standardize into w3f errCode. using {T,A, G, D} as place holder*

```
// JamError -> {"error":"ERR_NAME: ERR_DESC"}

{
  "error": "TicketsBadOrder: Submit tickets in bad order."
}
```

### Example QUIC Response

*(Not exposed in this PoC.)*  QUIC is expecting codec-encoded `StateTransitionResponse` as State++JamError++Mutated(bool) 

a JSON equivalent:
```
// StateTransitionResponse: Original
{
  "mutated": false,
  "post_state": {
    "state_root": "0x1234abcd...2345",
    "keyvals": [
      [
        "0x_32byte_key",
        "0x_val",
        "optional_label",
        "optional_metadata"
      ],
      ...
    ]
  },
  "error": null
}

// StateTransitionResponse: Mutated
{
  "mutated": true,
  "post_state": null
  "error": "TicketsBadOrder: Submit tickets in bad order."
}
```

## State Transition Errors

We defer to W3F for official error codes and descriptions. The PoC will randomly fuzz errors found in {**T** & **A**}; {**G** & **D**} are partially covered but not fully exposed.

### Safrole Ticket Errors

| Error Code | Error Name              | Description                                                    |
|-----------:|-------------------------|----------------------------------------------------------------|
| T1         | BadTicketAttemptNumber  | Submit an extrinsic with a bad ticket attempt number.          |
| T2         | TicketAlreadyInState    | Submit one ticket already recorded in the state.               |
| T3         | TicketsBadOrder         | Submit tickets in bad order.                                   |
| T4         | BadRingProof            | Submit tickets with a bad ring proof.                          |
| T5         | EpochLotteryOver        | Submit tickets when the epoch's lottery is over.               |
| T6         | TimeslotNotMonotonic    | Progress from slot X to slot X. Timeslot must be strictly monotonic. |

### Assurances Errors

| Error Code | Error Name              | Description                                                     |
|-----------:|-------------------------|-----------------------------------------------------------------|
| A1         | BadSignature           | One assurance has a bad signature.                              |
| A2         | BadValidatorIndex      | One assurance has a bad validator index.                        |
| A3         | BadCore                | One assurance targets a core without any assigned work report.  |
| A4         | BadParentHash          | One assurance has a bad attestation parent hash.                |
| A5         | StaleReport            | One assurance targets a core with a stale report.               |
| A6         | DuplicateAssurer       | Duplicate assurer.                                              |
| A7         | NotSortedAssurers      | Assurers not sorted.                                            |

### Guarantee & Work Reports Errors

| Error Code | Error Name                                 | Description                                                                                         |
|-----------:|--------------------------------------------|-----------------------------------------------------------------------------------------------------|
| G1         | BadCodeHash                                | Work result code hash doesn't match the one expected for the service.                               |
| G2         | BadCoreIndex                               | Core index is too big.                                                                              |
| G3         | BadSignature                               | Invalid report guarantee signature.                                                                 |
| G4         | CoreEngaged                                | A core is not available.                                                                            |
| G5         | DependencyMissing                          | Prerequisite is missing.                                                                            |
| G6         | DuplicatePackageTwoReports                 | Report contains a duplicate package (two reports from the same package).                            |
| G7         | FutureReportSlot                           | Report refers to a slot in the future with respect to container block slot.                         |
| G8         | InsufficientGuarantees                     | Report without enough guarantors' signatures.                                                       |
| G9         | DuplicateGuarantors                        | Guarantors' indices are not sorted or unique.                                                       |
| G10        | OutOfOrderGuarantee                        | Reports' cores are not sorted or unique.                                                            |
| G11        | WorkReportGasTooHigh                       | Work report per-core gas is too high.                                                               |
| G12        | ServiceItemTooLow                          | Accumulate gas is below the service minimum.                                                        |
| G13        | BadValidatorIndex                          | Validator index is too big.                                                                         |
| G14        | WrongAssignment                            | Unexpected guarantor for a work report core.                                                        |
| G15        | AnchorNotRecent                            | Context anchor is not recent enough.                                                                |
| G16        | BadBeefyMMRRoot                            | Context Beefy MMR root doesn't match the one at anchor.                                             |
| G17        | BadServiceID                               | Work result service identifier doesn't have any associated account in state.                        |
| G18        | BadStateRoot                               | Context state root doesn't match the one at anchor.                                                 |
| G19        | DuplicatePackageRecentHistory              | Package was already available in recent history.                                                    |
| G20        | ReportEpochBeforeLast                      | Report guarantee slot is too old with respect to the block slot.                                    |
| G21        | SegmentRootLookupInvalidNotRecentBlocks    | Segments tree root lookup item not found in recent blocks history.                                  |
| G22        | SegmentRootLookupInvalidUnexpectedValue    | Segments tree root lookup found in recent blocks history but with an unexpected value.             |
| G23        | CoreWithoutAuthorizer                      | Target core without any authorizer.                                                                 |
| G24        | CoreUnexpectedAuthorizer                   | Target core with an unexpected authorizer.                                                          |

### Disputes Errors

| Error Code | Error Name                          | Description                                                                                     |
|-----------:|-------------------------------------|-------------------------------------------------------------------------------------------------|
| D1         | NotSortedWorkReports                | Not sorted work reports within a verdict.                                                       |
| D2         | NotUniqueVotes                      | Not unique votes within a verdict.                                                              |
| D3         | NotSortedValidVerdicts              | Not sorted, valid verdicts.                                                                     |
| D4         | NotHomogenousJudgements             | Not homogeneous judgements; positive votes count is incorrect.                                  |
| D5         | MissingCulpritsBadVerdict           | Missing culprits for bad verdict.                                                               |
| D6         | SingleCulpritBadVerdict             | Single culprit for bad verdict.                                                                 |
| D7         | TwoCulpritsBadVerdictNotSorted      | Two culprits for bad verdict, not sorted.                                                       |
| D8         | AlreadyRecordedVerdict              | Report an already recorded verdict with culprits.                                               |
| D9         | CulpritAlreadyInOffenders           | Culprit offender already in the offenders list.                                                 |
| D10        | OffenderNotPresentVerdict           | Offender relative to a not-present verdict.                                                     |
| D11        | MissingFaultsGoodVerdict            | Missing faults for good verdict.                                                                |
| D12        | TwoFaultOffendersGoodVerdict        | Two fault offenders for a good verdict, not sorted.                                             |
| D13        | AlreadyRecordedVerdictWithFaults    | Report an already recorded verdict, with faults.                                                |
| D14        | FaultOffenderInOffendersList        | Fault offender already in the offenders list.                                                   |
| D15        | AuditorMarkedOffender               | Auditor marked as offender, but vote matches the verdict.                                       |
| D16        | BadSignatureInVerdict               | Bad signature within the verdict judgements.                                                    |
| D17        | BadSignatureInCulprits              | Bad signature within the culprits sequence.                                                     |
| D18        | AgeTooOldInVerdicts                 | Age too old for verdicts judgements.                                                            |

## Verbose Mode

*Partially Implemented for PoC.* When `verbose` is enabled, `importblocks` will provide additional logs on the process. This may help teams compare their endpoint’s output with the expected values, facilitating debugging and validation of their implementation.

## Grading Methods & Metrics Breakdown

The following metrics are automatically generated for informational purposes only and *do not* determine correctness of either the sender or receiver implementation. (A faulty STF implementation might still have a 100% match rate against its own fuzz logic.)

### Basic Metrics

| **Key**          | **Description**                                  |
|:----------------:|:------------------------------------------------:|
| `TotalBlocks`    | Total count of all blocks processed             |
| `FuzzedBlocks`   | Number of these blocks that were fuzzed         |
| `OriginalBlocks` | Number of these blocks that were original       |
| `FuzzedRate`     | `FuzzedBlocks / TotalBlocks`                    |

### Fuzzed Metrics

| **Key**                 | **Formula**                             | **Description**                                                |
|:-----------------------:|:---------------------------------------:|:--------------------------------------------------------------:|
| `TruePositiveRate`      | `FuzzTruePositives / FuzzedBlocks`      | Fraction of fuzzed blocks correctly detected                   |
| `FalseNegativeRate`     | `FuzzFalseNegatives / FuzzedBlocks`     | Fraction of fuzzed blocks that were missed                     |
| `ResponseErrorRate`     | `FuzzResponseErrors / FuzzedBlocks`     | Fraction of fuzzed blocks that caused response errors          |
| `MisclassificationRate` | `FuzzMisclassifications / FuzzedBlocks` | Fraction of fuzzed blocks misclassified                        |

### Original Metrics

| **Key**                 | **Formula**                                 | **Description**                                                     |
|:-----------------------:|:-------------------------------------------:|:--------------------------------------------------------------------|
| `FalsePositiveRate`     | `OrigFalsePositives / OriginalBlocks`       | Fraction of original blocks wrongly flagged                         |
| `TrueNegativeRate`      | `OrigTrueNegatives / OriginalBlocks`        | Fraction of original blocks correctly validated                     |
| `ResponseErrorRate`     | `OrigResponseErrors / OriginalBlocks`       | Fraction of original blocks that caused response errors             |
| `MisclassificationRate` | `OrigMisclassifications / OriginalBlocks`   | Fraction of original blocks misclassified                           |

### Overall Metrics

| **Key**                  | **Formula**                                                           | **Description**                                                                      |
|:------------------------:|:---------------------------------------------------------------------:|:-------------------------------------------------------------------------------------:|
| `FlaggedRate`            | `(FuzzTruePositives + OrigFalsePositives) / TotalBlocks`             | Fraction of blocks flagged (correctly or incorrectly)                                |
| `CorrectRate`            | `(FuzzTruePositives + OrigTrueNegatives) / TotalBlocks`              | Fraction of blocks correctly handled (fuzzed recognized + original not flagged)      |
| `ResponseErrorRate`      | `(FuzzResponseErrors + OrigResponseErrors) / TotalBlocks`            | Fraction of blocks that caused response errors (fuzzed + original)                   |
| `MisclassificationRate`  | `(FuzzMisclassifications + OrigMisclassifications) / TotalBlocks`    | Fraction of blocks misclassified in total (fuzzed + original)                        |

# JAM Network Settings

For fuzzing to work, blocks and extrinsics require proper resealing and guesswork. It is strictly required that teams standardize on the same keys.

- `tiny`: [Doc Reference](https://docs.jamcha.in/basics/dev-accounts)
- `full`: Not supported by PoC

## Development Roadmap

As of December 2024, this is a Proof of Concept but can be reduced to practice. JAM Implementation Teams are encouraged to provide additional fuzzing ideas and general feedback.

- **Full QUIC Implementation**: Development of QUIC functionality for a more robust testing setup.
- **Expanded Modes and Fuzzing**: More modes and fuzzing techniques for block generation.
- **Enhanced Grading and Statistics**: Additional grading parameters as determined to be useful.
- **Pass-through fuzzing**: M2 compatible. Participates in live production.

# RFP for Multiple `importblocks` Implementations

For the same reasons JAM is being implemented by multiple teams in different languages to support resilient, non-buggy implementations (where no two implementations share the same bug), it may be desirable to have multiple `importblocks` implementations as well.

`importblocks` implementers would likely use their own JAM implementation as a source of STF “testbank.” The JAM DUNA `importblocks` can be used to ingest additional data as long as it follows the same STF formats.
